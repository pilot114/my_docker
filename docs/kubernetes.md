https://kubernetes.io/docs/tutorials/kubernetes-basics

Kubernetes — это предназначенный для контейнерной оркестровки фреймворк с открытым исходным кодом,
более зрелая альтернатива Docker Swarm, созданная в Google.
В Kubernetes приложения по сути не привязаны к отдельным хостам, благодаря тому
что они упакованы в контейнеры.

minikube - консольная утилита для локальной развертки кластера (в виртуалке)
kubectl - консольный клиент для Kubernetes

1) создаем кластер используя minikube
2) создаём деплой используя kubectl. Под деплоем подразумевается создание конфига,
включающего в себя выбор базовых образов, количество создаваемых реплик
и прочие настройки для контроля гарантированной доступности приложений (Deployment Controller).
3) создаем прокси для доступа ко внутренним сервисам извне.

Затем получаем через kubectl имена инстансов (подов), и по ним обращаемся к ним через апи.
Пример для пода kubernetes-bootcamp-390780338-qtbnk:

    curl http://localhost:8001/api/v1/proxy/namespaces/default/pods/kubernetes-bootcamp-390780338-qtbnk/
    
Под может быть как одним, так и несколькими контейнерами с общим IP адресом, volumes и т.д.
КОНТЕЙНЕРЫ ДОЛЖНЫ БЫТЬ В ОДНОМ ПОДЕ, если они плотно взаимодействуют, например используют
общий volume. Причем IP подов доступны только внутри сети.

На каждой ноде кластера должен быть установлен менеджер контейнеров (например, Docker или rkt)
и Kubelet - демон для связи с мастер-нодой.

Через kubectl можно напрямую выполнять любые команды в любом поде или запустить bash сессию.



### minikube и его связь с kubectl

* minikube start - создаёт контекст (настройку) kubectl, который называется minikube. Он содержит информацию
о связи с кластером minikube.
Тоже самое можно сделать, используя команду:

    kubectl config use-context minikube

Контекст можно также указывать для любой kubectl команды, например так:

    kubectl get pods --context=minikube

* minikube dashboard - web интерфейс для кластера

* minikube service [-n NAMESPACE] [--url] NAME - получить URL для доступа к сервису

kubectl get nodes - список доступных нод
kubectl cluster-info - вся основная информация о кластере (какие сервисы на каких нодах запущены)
kubectl cluster-info dump - сдампить всё текущее состояние в виде текстового файла

Вот так создается деплой - указываем образ и порт для публикации:
kubectl run kubernetes-bootcamp --image=docker.io/jocatalin/kubernetes-bootcamp:v1 --port=8080
kubectl get deployments - список всех деплоев
kubectl proxy - позволяет создать прокси для общения с сервисами. Без прокси они доступны только изнутри,
и могут взаимодействовать только друг с другом.
Также прокси автоматически создает эндпоинт для каждого пода. Для того чтобы получить эндпоинт пода,
нужно его получить из kubectl get pods:

    export POD_NAME=$(kubectl get pods -o go-template --template '{{range .items}}{{.metadata.name}}{{"\n"}}{{end}}')
    echo Name of the Pod: $POD_NAME

Теперь можно обратиться к приложению!

    curl http://localhost:8001/api/v1/proxy/namespaces/default/pods/$POD_NAME/

Запрос перенаправится к поду, ip и port будут выбраны автоматически.

Самые полезные команды (ресурс - это что угодно - поды, ноды и т.д.):
kubectl get - список ресурсов
kubectl describe - инфа о ресурсе
kubectl logs - логи пода. Логи хранят информацию о запросах с их порядковыми номерами
kubectl exec - выполнить команду в поде



### Сервисы

Сервис - абстракция для логического объединения подов и политики доступа к этой группе.
По сути, весь траффик в приложения приходит через сервисы.
Благодаря использованию сервисов, внешнее переключение с одного пода-реплики
на другой не приводит к изменению параметров подключения.

Сервисы, как и все объекты kubernetes, описываются в виде Yaml.
Поды, подключаемые к сервису, обычно определяются через label.

Типы сервисов:

    - ClusterIP - открывает сервис на внутреннем адресе. Сервис доступен только изнутри.
    - NodePort - открывает сервис на одном и том же порту на одном и более IP. Для доступа извне.
    - LoadBalancer - балансировщик нагрузки на фиксированном внешнем IP.
    - ExternalName - создает CNAME для сервиса. Требует kube-dns.

Для удобного управления соотвествием сервисов и подов используются labels и selectors, которые позволяют
обрабатывать множество юзкейсов: разделение, на dev/test/prod, версионирование, классификация.

Можно создать сервис одновременно с деплоем, используя --expose.

Получить все под по label можно например так:

    kubectl get pods -l run=kubernetes-bootcamp

Назначить новый label на под:

    kubectl label pod $POD_NAME app=v1

Как видно, удобно назначать label в формате ТИП_МЕТКИ=НАЗВАНИЕ_МЕТКИ, чтобы не конфликтовать
с метками, которые могут создаваться по умолчанию.


### Маштабирование

Маштабировать поды можно автоматически, вплоть до нуля (остановка обслуживания).
Сервисы имеют свтроенный балансировщик нагрузки, а монитор сервисов гарантирует распределение
только на работающие поды.

kubectl get deployments - посмотреть кол-во и состояние реплик.

DESIRED - сколько реплик сконфигурено.
CURRENT - запущено сейчас.
UP-TO-DATE - которые обновлено до актуального состояния.
AVAILABLE - доступны пользователям.

Промаштабировать:

    kubectl scale deployments/kubernetes-bootcamp --replicas=4
    
Посмотреть каждый:

    kubectl get pods -o wide

Если реплик несколько, внешние запросы будут равномерно распределяться между репликами.

Уменьшение числа реплик просто выключает, но не удаляет инстрансы.


### Обновление приложений

По умолчанию, максимальное кол-во подов недоступных во время обновления и максимальное
кол-во новых подов - это одно и то же число. Эти опции задаются как число или процент
от общего числа подов. В Kubernetes каждое обновление версионируется, что позволяет откатываться
к предыдущей версии.

Таким образом, обновление делается через маштабирование.

Пример обновления:

    kubectl set image deployments/kubernetes-bootcamp kubernetes-bootcamp=jocatalin/kubernetes-bootcamp:v2

Тут мы ставим новую версию образа jocatalin/kubernetes-bootcamp для
деплоя kubernetes-bootcamp.

Подтвердить развертывание:

    kubectl rollout status deployments/kubernetes-bootcamp

Отменить развертывание:

    kubectl rollout undo deployments/kubernetes-bootcamp

